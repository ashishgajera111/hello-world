<?php

class Mageez_Moxipay_Model_Paymentmethod extends Mage_Payment_Model_Method_Abstract {
    protected $_code  = 'moxipay';
    protected $_formBlockType = 'moxipay/form';

    public function getOrderPlaceRedirectUrl()
    {
        $this->prepareRequest();
        //return Mage::getUrl('custompaymentmethod/payment/redirect', array('_secure' => false));
    }
    
   public function prepareRequest(){
        
        if( Mage::getStoreConfig('payment/moxipay/testmode') == 1 ){
            $this->url = Mage::getStoreConfig('payment/moxipay/stagingurl');
            $clientid = Mage::getStoreConfig('payment/moxipay/client_id_test');
            $clientsecret = Mage::getStoreConfig('payment/moxipay/client_secret_test');
        }else{
            $this->url = Mage::getStoreConfig('payment/moxipay/productionurl');
            $clientid = Mage::getStoreConfig('payment/moxipay/client_id');
            $clientsecret = Mage::getStoreConfig('payment/moxipay/client_secret');            
            //return;
        }
        // set post fields
        $post = [
            'client_id' => $clientid,
            'client_secret' => $clientsecret,
            'username'   => Mage::getStoreConfig('payment/moxipay/username'),
            'password'   => Mage::getStoreConfig('payment/moxipay/password'),
            'grant_type'   => 'password',
            'scope'   => 'merchant'
        ];

        $ch = curl_init($this->url.'oauth/access_token');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post);

        $response = curl_exec($ch);
        curl_close($ch);
        $response = json_decode($response);     
                
        if( isset($response->error) ){
            //echo $response->error.'<br>';
            //echo $response->error_description;
            
            Mage::throwException($response->error." ".$response->error_description);
            return;
        }

        if( isset($response->access_token) ){
            $accessToken = $response->access_token;
            $this->sendRequest($accessToken);
        }
    }

    public function sendRequest($accessToken){
        
        $last_order_increment_id = Mage::getModel("sales/order")->getCollection()->getLastItem()->getIncrementId();
        Mage::log('START Request ------------------------------'.$last_order_increment_id, null, 'moxipay.log');
        $order = Mage::getSingleton('sales/order')->loadByIncrementId($last_order_increment_id);
        if(Mage::getSingleton('customer/session')->isLoggedIn()) {
            $customerData = Mage::getSingleton('customer/session')->getCustomer();
            $customerId =  $customerData->getId();
        }else{
            $customerId = '99999999';
        }        
        
        $post = [
            'access_token' => $accessToken,
            'amount' => $order->getGrandTotal(),
            'invoice'   => $order->getId(),
            'question'   => 'Your Order ID',
            'answer'   => $last_order_increment_id,
            'uniqueid'   => $last_order_increment_id,
            'userid'   => $customerId,
            'customername'   => $order->getBillingAddress()->getName(),
            'customeremail'   => $order->getBillingAddress()->getEmail(),
            'ipnurl'   => Mage::getBaseUrl().'moxipay/index/ipn/'
        ];

        $ch = curl_init($this->url.'merchant/populateemtpayment');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post);

        $response = curl_exec($ch);
        
        $order->addStatusHistoryComment('Response '.$response);
        if($order->save()){
            $this->sendmail($order->getIncrementId(), $order->getBillingAddress()->getEmail());
        }        

        $last_order_increment_id = Mage::getModel("sales/order")->getCollection()->getLastItem()->getIncrementId();
        Mage::log('Moxipay Response '.$response.' > order id '.$last_order_increment_id, null, 'moxipay.log');
        Mage::log('END Request ------------------------------'.$last_order_increment_id, null, 'moxipay.log');
        curl_close($ch);

        return;
    }   
    
    public function sendmail($orderid, $email){
        
        //Mage::log('Mailing '.$email.' '.$last_order_increment_id, null, 'moxipay.log');
        
        //$to = Mage::getStoreConfig('payment/moxipay/processoremail');
        $to = $email;

        $subject = 'Complete Your Order - Transfer Instructions';

        $headers = "From: ".Mage::getStoreConfig('payment/moxipay/merchantemail')."\r\n";
        $headers .= "Reply-To: ".Mage::getStoreConfig('payment/moxipay/merchantemail')."\r\n";
        //$headers .= "CC: ".Mage::getStoreConfig('payment/moxipay/merchantemail')."\r\n";
        $headers .= "MIME-Version: 1.0\r\n";
        $headers .= "Content-Type: text/html; charset=ISO-8859-1\r\n";    
        
        $message = "<div style='font-size:16px;width: 550px;margin: 0 auto;font-family:Arial;color:#000'>";
         
        $message .= "<p>Kindly follow these instructions to complete your order using our <strong>Interac E-transfer</strong> payment method:</p>";
        $message .= "<p><strong>Recipient Email:</strong> puregreen@emtpay.ca</p>";
        $message .= "<p>(Note: The payment will be made to Moxipay Corporation Inc.)</p>";
        $message .= "<p><strong>IF</strong> you are asked to provide a security question and an answer, follow this format strictly:</p>";
        $message .= "<p>Secret Question:  <strong>“Your Order ID”</strong></p>";
        $message .= "<p>Answer:  <strong>".$orderid."</strong></p>";
        $message .= "<p>(Note: Type <strong>ONLY</strong> your <strong>Order Number ".$orderid."</strong>)<br>*Including this number helps us to correctly match your payment to your order.</p>";

        $message .= "<p><strong>Please</strong> ensure that all the information provided are correct and <strong>matches</strong> your EMT exactly.</p>";
        $message .= "<p>Once payment is received, your order status will automatically be updated to “Processing” status. You will receive your tracking number soon after and you should receive your order within 2-3 days. </p>";
        $message .= "<p>Thanks for being a great customer! </p>";
        $message .= "<div style='text-align:center'>";
        $message .= "<img src='https://www.puregreenexpress.ca/skin/frontend/default/theme292k/images/logo_square.png' />";
        $message .= "</div>";         
        $message .= "</div>";
        
        mail($to, $subject, $message, $headers);
        return;
    }
}